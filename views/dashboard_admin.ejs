<%- include('partials/header') %>

<main class="dashboard admin">
    <h2>Admin Dashboard</h2>

    <div class="dashboard-content">
        <% if (locals.messages && messages.length > 0) { %>
            <div class="flash-messages">
                <% messages.forEach(function(message) { %>
                    <div class="alert alert-<%= message.type %>"><%= message.text %></div>
                <% }); %>
            </div>
        <% } %>

        <div class="admin-info">
            <h3>Bienvenido, <%= user.name %></h3>
            <p>Panel de Administracion</p>
        </div>

        <div class="admin-dashboard-layout">
            <%- include('partials/admin_menu') %>

            <div class="admin-main-content">
                <%- include('partials/admin_management') %>
                <%- include('partials/create_product_section') %>
                <%- include('partials/product_management_section') %>
                <%- include('partials/kpi_dashboard') %>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const links = document.querySelectorAll('.sidebar-link');
    const sections = document.querySelectorAll('.admin-section-content');

    // Function to switch sections
    function showSection(targetId) {
        sections.forEach(section => {
            if (section.id === targetId) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        });
    }

    // Handle sidebar link clicks
    links.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.dataset.target;

            // Update active link
            links.forEach(l => l.classList.remove('active'));
            this.classList.add('active');

            // Show target section
            showSection(targetId);

            // Update URL hash without jumping
            history.pushState(null, null, `#${targetId}`);
        });
    });

    // Show section based on URL hash on page load
    const currentHash = window.location.hash.substring(1);
    if (currentHash) {
        const targetLink = document.querySelector(`.sidebar-link[data-target="${currentHash}"]`);
        if (targetLink) {
            links.forEach(l => l.classList.remove('active'));
            targetLink.classList.add('active');
            showSection(currentHash);
        }
    } else {
        // Show the first section by default if no hash
        showSection(sections[0].id);
        links[0].classList.add('active');
    }


    fetch('/api/kpis')
      .then(response => response.json())
      .then(kpis => {
        // 1. Sales Over Time Chart (Line)
        new Chart(document.getElementById('salesOverTimeChart'), {
          type: 'line',
          data: {
            labels: kpis.salesOverTime.labels,
            datasets: [{
              label: 'Ventas ($)',
              data: kpis.salesOverTime.data,
              borderColor: 'rgba(75, 192, 192, 1)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              fill: true,
              tension: 0.1
            }]
          }
        });

        // 2. Top Selling Products Chart (Bar)
        new Chart(document.getElementById('topSellingProductsChart'), {
          type: 'bar',
          data: {
            labels: kpis.topSellingProducts.labels,
            datasets: [{
              label: 'Unidades Vendidas',
              data: kpis.topSellingProducts.data,
              backgroundColor: [
                'rgba(255, 99, 132, 0.5)',
                'rgba(54, 162, 235, 0.5)',
                'rgba(255, 206, 86, 0.5)',
                'rgba(75, 192, 192, 0.5)',
                'rgba(153, 102, 255, 0.5)'
              ]
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });

        // 3. Low Stock Products Chart (Horizontal Bar)
        new Chart(document.getElementById('lowStockProductsChart'), {
          type: 'bar',
          data: {
            labels: kpis.lowStockProducts.labels,
            datasets: [{
              label: 'Unidades en Stock',
              data: kpis.lowStockProducts.data,
              backgroundColor: 'rgba(255, 159, 64, 0.5)'
            }]
          },
          options: {
            indexAxis: 'y',
            scales: {
              x: {
                beginAtZero: true
              }
            }
          }
        });
      })
      .catch(error => console.error('Error fetching KPI data:', error));
  });

  async function handleDelete(event) {
    event.preventDefault(); // Prevent default form submission

    const form = event.target;
    const productId = form.dataset.productId;

    if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) {
      return; // User cancelled
    }

    try {
      const response = await fetch(`/products/${productId}/delete`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      const data = await response.json();

      if (data.success) {
        const row = form.closest('tr');
        if (row) {
          row.remove();
        }
        alert(data.message);
      } else {
        alert('Error: ' + data.message);
      }
    } catch (error) {
      alert('Ocurrió un error inesperado al eliminar el producto.');
    }
  }
</script>

<%- include('partials/footer') %>
