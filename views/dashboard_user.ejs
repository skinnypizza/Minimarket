<%- include('partials/header') %>
<main class="dashboard">
    <h2>Tienda Online</h2>
    <div class="dashboard-content">
        <div class="user-info">
            <h3>Bienvenido, <%= user.name %></h3>
            <p>Email: <%= user.email %></p>
        </div>
        
        <!-- Carrusel de Productos -->
        <div class="product-carousel">
            <h3>Nuestros Productos</h3>
            <div class="carousel-container" id="productCarousel">
                <% if (products && products.length > 0) { %>
                    <% products.forEach(product => { %>
                        <div class="product-card">
                            <div class="product-image">
                                <% if (product.image) { %>
                                    <img src="<%= product.image %>" alt="<%= product.name %>" />
                                <% } else { %>
                                    <div class="no-image">
                                        <i class="fas fa-image"></i>
                                        <span>Sin imagen</span>
                                    </div>
                                <% } %>
                            </div>
                            <h4><%= product.name %></h4>
                            <p><%= product.description || 'Sin descripción' %></p>
                            <div class="price">$<%= product.price.toFixed(2) %></div>
                            <div class="stock">Stock: <%= product.stock %></div>
                            <button class="btn add-to-cart" data-product-id="<%= product._id %>" data-product-name="<%= product.name %>" data-product-price="<%= product.price %>">
                                Agregar al Carrito
                            </button>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="no-products">
                        <p>No hay productos disponibles en este momento.</p>
                    </div>
                <% } %>
            </div>
            <button class="carousel-btn prev" id="prevBtn">‹</button>
            <button class="carousel-btn next" id="nextBtn">›</button>
        </div>

        <!-- Carrito de Compras -->
        <div class="cart-section">
            <h3>Carrito de Compras <span class="cart-badge"><span class="cart-count" id="cartCount">0</span></h3>
            <div id="cartItems">
                <p class="empty-cart">Tu carrito está vacío</p>
            </div>
            <div class="cart-total" id="cartTotal" style="display: none;">
                <h4>Total: $<span id="totalAmount">0.00</span></h4>
                <button class="btn" id="checkoutBtn">Proceder al Pago</button>
            </div>
        </div>
    </div>
</main>

<script>
// Carrito de compras
let cart = [];
let currentSlide = 0;
const itemsPerSlide = 3;

// Funciones del carrito
function addToCart(productId, productName, productPrice) {
    const existingItem = cart.find(item => item.id === productId);
    
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: productId,
            name: productName,
            price: productPrice,
            quantity: 1
        });
    }
    
    updateCartDisplay();
    showNotification('Producto agregado al carrito');
}

function removeFromCart(productId) {
    cart = cart.filter(item => item.id !== productId);
    updateCartDisplay();
}

function updateQuantity(productId, change) {
    const item = cart.find(item => item.id === productId);
    if (item) {
        item.quantity += change;
        if (item.quantity <= 0) {
            removeFromCart(productId);
        } else {
            updateCartDisplay();
        }
    }
}

function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const cartCount = document.getElementById('cartCount');
    const cartTotal = document.getElementById('cartTotal');
    const totalAmount = document.getElementById('totalAmount');
    
    cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="empty-cart">Tu carrito está vacío</p>';
        cartTotal.style.display = 'none';
    } else {
        cartItems.innerHTML = cart.map(item => `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-title">${item.name}</div>
                    <div class="cart-item-price">$${item.price.toFixed(2)} c/u</div>
                </div>
                <div class="cart-item-quantity">
                    <button class="quantity-btn" onclick="updateQuantity('${item.id}', -1)">-</button>
                    <span>${item.quantity}</span>
                    <button class="quantity-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                    <button class="btn" onclick="removeFromCart('${item.id}')" style="margin-left: 10px; padding: 0.3rem 0.8rem; font-size: 0.8rem;">Eliminar</button>
                </div>
            </div>
        `).join('');
        
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        totalAmount.textContent = total.toFixed(2);
        cartTotal.style.display = 'flex';
    }
}

function showNotification(message) {
    // Crear notificación temporal
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #52b788;
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Funciones del carrusel
function updateCarousel() {
    const carousel = document.getElementById('productCarousel');
    const slideWidth = 100 / itemsPerSlide;
    carousel.style.transform = `translateX(-${currentSlide * slideWidth}%)`;
}

function nextSlide() {
    const totalSlides = Math.ceil(document.querySelectorAll('.product-card').length / itemsPerSlide);
    currentSlide = (currentSlide + 1) % totalSlides;
    updateCarousel();
}

function prevSlide() {
    const totalSlides = Math.ceil(document.querySelectorAll('.product-card').length / itemsPerSlide);
    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
    updateCarousel();
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Botones del carrito
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const productName = this.dataset.productName;
            const productPrice = parseFloat(this.dataset.productPrice);
            addToCart(productId, productName, productPrice);
        });
    });
    
    // Botones del carrusel
    document.getElementById('nextBtn').addEventListener('click', nextSlide);
    document.getElementById('prevBtn').addEventListener('click', prevSlide);
    
    // Botón de checkout
    document.getElementById('checkoutBtn').addEventListener('click', async function() {
        if (cart.length === 0) {
            return;
        }

        try {
            const response = await fetch('/cart/checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cart }),
            });

            const result = await response.json();

            if (result.success) {
                showNotification(result.message);
                cart = [];
                updateCartDisplay();
                // Optionally, refresh the product list to show updated stock
                location.reload(); 
            } else {
                showNotification(result.message);
            }
        } catch (err) {
            console.error('Error en el checkout:', err);
            showNotification('Error al procesar la compra.');
        }
    });
    
    // Auto-slide del carrusel cada 5 segundos
    setInterval(nextSlide, 5000);
});
</script>

<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.empty-cart {
    text-align: center;
    color: #999;
    font-style: italic;
    padding: 2rem;
}

.no-products {
    text-align: center;
    color: #999;
    font-style: italic;
    padding: 2rem;
    grid-column: 1 / -1;
}

/* Estilos para imágenes de productos */
.product-image {
    width: 100%;
    height: 200px;
    margin-bottom: 1rem;
    border-radius: 10px;
    overflow: hidden;
    background: var(--gris-claro);
    display: flex;
    align-items: center;
    justify-content: center;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.product-image img:hover {
    transform: scale(1.05);
}

.no-image {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--gris-medio);
    height: 100%;
}

.no-image i {
    font-size: 3rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

.no-image span {
    font-size: 0.9rem;
    font-style: italic;
}
</style>

<%- include('partials/footer') %>